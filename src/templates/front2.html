<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Voice Clone Studio</title>
    <style>
        :root {
            --bg: #0f172a;
            --bg-soft: #111827;
            --card: #111827;
            --muted: #9ca3af;
            --text: #e5e7eb;
            --primary: #6366f1;
            --primary-600: #5457ee;
            --success: #10b981;
            --danger: #ef4444;
            --border: #1f2937;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0; padding: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            color: var(--text); background: radial-gradient(1200px 800px at 20% -10%, #1f2937 0, transparent 60%),
            radial-gradient(1000px 700px at 100% 0%, #1f2937 0, transparent 60%), var(--bg);
            min-height: 100vh;
        }
        .container { max-width: 1100px; margin: 0 auto; padding: 24px; }
        header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
        .brand { display: flex; align-items: center; gap: 12px; }
        .brand-logo { width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary), #22d3ee); border-radius: 10px; box-shadow: 0 10px 30px rgba(34, 211, 238, .2); }
        h1 { font-size: 22px; margin: 0; letter-spacing: .3px; }
        .subtitle { color: var(--muted); font-size: 13px; margin-top: 4px; }

        .grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 900px) { .grid { grid-template-columns: 1fr 1fr; } }

        .card { background: rgba(17,24,39,.9); border: 1px solid var(--border); border-radius: 14px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.35); backdrop-filter: blur(6px); }
        .card h2 { margin: 0 0 12px; font-size: 18px; }
        .card p.hint { margin: 6px 0 16px; color: var(--muted); font-size: 13px; }

        .form-row { display: grid; grid-template-columns: 1fr; gap: 12px; }
        @media (min-width: 640px) { .form-row { grid-template-columns: 1fr 1fr; } }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        label { font-size: 13px; color: var(--muted); }
        input[type="text"], select { background: #0b1220; color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px; outline: none; transition: border .2s ease, box-shadow .2s ease; }
        input[type="text"]:focus, select:focus { border-color: #334155; box-shadow: 0 0 0 3px rgba(99, 102, 241, .15); }
        .actions { display: flex; gap: 12px; }
        button { border: 0; background: var(--primary); color: white; padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 600; letter-spacing: .2px; display: inline-flex; align-items: center; gap: 10px; transition: background .2s ease, transform .06s ease; }
        button.secondary { background: #1f2937; color: var(--text); border: 1px solid var(--border); font-weight: 500; }
        button:hover { background: var(--primary-600); }
        button:active { transform: translateY(1px); }
        button[disabled] { opacity: .6; cursor: not-allowed; }
        .spinner { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,.35); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .audio-wrap { margin-top: 12px; background: #0b1220; border: 1px solid var(--border); border-radius: 12px; padding: 12px; }
        audio { width: 100%; height: 36px; }

        .toast { position: fixed; right: 20px; bottom: 20px; background: #1f2937; color: var(--text); border: 1px solid var(--border); border-left: 4px solid var(--primary); padding: 12px 14px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,.35); display: none; min-width: 260px; }
        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--danger); }
        .note { color: var(--muted); font-size: 12px; margin-top: 8px; }
        .pill { display: inline-block; padding: 4px 8px; border-radius: 999px; background: #0b1220; border: 1px solid var(--border); color: var(--muted); font-size: 12px; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <div class="brand">
                <div class="brand-logo"></div>
                <div>
                    <h1>Voice Clone Studio</h1>
                    <div class="subtitle">Generate speech, convert voices, and manage profiles</div>
                </div>
            </div>
            <div class="pill" id="profileCount">Profiles: ‚Äî</div>
        </header>

        <div class="grid">
            <section class="card" id="ttsCard">
                <h2>üó£Ô∏è Text ‚Üí Speech</h2>
                <p class="hint">Enter text and pick a voice to synthesize natural speech.</p>
                <div class="form-group">
                    <label for="ttsText">Text</label>
                    <input type="text" id="ttsText" placeholder="Type what you want the voice to say" value="Hello, this is a test.">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="ttsProfile">Voice Profile</label>
                        <select id="ttsProfile">
                            <option value="harry">Harry</option>
                            <option value="sophie" selected>Sophie</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="temperature">Temperature</label>
                        <select id="temperature">
                            <option value="0.7">0.7</option>
                            <option value="0.8" selected>0.8</option>
                            <option value="0.9">0.9</option>
                        </select>
                    </div>
                </div>
                <div class="actions">
                    <button id="btnTTS" onclick="generateTTS()">
                        <span>Generate Speech</span>
                    </button>
                    <button class="secondary" onclick="clearAudio('ttsAudio')">Clear</button>
                </div>
                <div class="audio-wrap">
                    <audio id="ttsAudio" controls></audio>
                </div>
            </section>

            <section class="card" id="vcCard">
                <h2>üîÅ Speech ‚Üí Speech</h2>
                <p class="hint">Upload a source audio and convert it into the target voice.</p>
                <div class="form-row">
                    <div class="form-group">
                        <label for="vcFile">Source Audio</label>
                        <input type="file" id="vcFile" accept="audio/*">
                    </div>
                    <div class="form-group">
                        <label for="vcProfile">Target Voice</label>
                        <select id="vcProfile">
                            <option value="harry">Harry</option>
                            <option value="sophie" selected>Sophie</option>
                        </select>
                    </div>
                </div>
                <div class="actions">
                    <button id="btnVC" onclick="convertVoice()">
                        <span>Convert Voice</span>
                    </button>
                    <button class="secondary" onclick="clearAudio('vcAudio')">Clear</button>
                </div>
                <div class="audio-wrap">
                    <audio id="vcAudio" controls></audio>
                </div>
            </section>

            <section class="card" id="saveCard" style="grid-column: 1 / -1;">
                <h2>üíæ Save New Voice Profile</h2>
                <p class="hint">Upload a voice sample and give it a simple name (e.g., ‚Äúalice‚Äù, ‚Äúbob‚Äù).</p>
                <div class="form-row">
                    <div class="form-group">
                        <label for="profileName">Profile Name</label>
                        <input type="text" id="profileName" placeholder="e.g., alice" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="profileFile">Voice Sample (.wav, .mp3, .flac, .aac)</label>
                        <input type="file" id="profileFile" accept="audio/*">
                    </div>
                </div>
                <div class="actions">
                    <button id="btnSave" onclick="saveProfile()">
                        <span>Save Profile</span>
                    </button>
                    <button class="secondary" onclick="resetSaveForm()">Reset</button>
                </div>
                <div class="note" id="saveHint">Tip: Use lowercase letters and avoid spaces for best compatibility.</div>
            </section>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        const btnTTS = document.getElementById('btnTTS');
        const btnVC = document.getElementById('btnVC');
        const btnSave = document.getElementById('btnSave');
        const ttsProfileSel = document.getElementById('ttsProfile');
        const vcProfileSel = document.getElementById('vcProfile');
        const profileCount = document.getElementById('profileCount');

        function showToast(message, type = 'info') {
            const el = document.getElementById('toast');
            el.className = 'toast';
            if (type === 'success') el.classList.add('success');
            if (type === 'error') el.classList.add('error');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 2800);
        }

        function withLoading(buttonEl, fn) {
            return async (...args) => {
                const original = buttonEl.innerHTML;
                buttonEl.setAttribute('disabled', 'true');
                buttonEl.innerHTML = '<span class="spinner"></span><span>Working...</span>';
                try {
                    return await fn(...args);
                } catch (e) {
                    throw e;
                } finally {
                    buttonEl.removeAttribute('disabled');
                    buttonEl.innerHTML = original;
                }
            }
        }

        function savePrefs() {
            const prefs = {
                ttsProfile: ttsProfileSel.value,
                vcProfile: vcProfileSel.value,
                ttsText: document.getElementById('ttsText').value,
                temperature: document.getElementById('temperature').value
            };
            localStorage.setItem('vc_prefs', JSON.stringify(prefs));
        }

        function loadPrefs() {
            try {
                const raw = localStorage.getItem('vc_prefs');
                if (!raw) return;
                const prefs = JSON.parse(raw);
                if (prefs.ttsText) document.getElementById('ttsText').value = prefs.ttsText;
                if (prefs.temperature) document.getElementById('temperature').value = prefs.temperature;
                if (prefs.ttsProfile) ttsProfileSel.value = prefs.ttsProfile;
                if (prefs.vcProfile) vcProfileSel.value = prefs.vcProfile;
            } catch {}
        }

        async function loadProfiles() {
            try {
                const res = await fetch('/voice_profiles');
                if (!res.ok) throw new Error(await res.text());
                const data = await res.json();
                profileCount.textContent = `Profiles: ${data.count}`;

                // Get current options to avoid duplication
                const currentOptions = new Set(Array.from(ttsProfileSel.options).map(o => o.value));

                // Add profiles dynamically if not already present
                for (const profileName of data.profiles || []) {
                    if (!currentOptions.has(profileName)) {
                        const opt1 = document.createElement('option');
                        opt1.value = profileName;
                        opt1.textContent = profileName.charAt(0).toUpperCase() + profileName.slice(1);
                        ttsProfileSel.appendChild(opt1);

                        const opt2 = document.createElement('option');
                        opt2.value = profileName;
                        opt2.textContent = profileName.charAt(0).toUpperCase() + profileName.slice(1);
                        vcProfileSel.appendChild(opt2);
                    }
                }

                loadPrefs();
            } catch (e) {
                showToast(`Failed to load profiles: ${e.message || e}`, 'error');
            }
        }

        function clearAudio(id) {
            const el = document.getElementById(id);
            el.removeAttribute('src');
            el.load();
        }

        const _generateTTS = withLoading(btnTTS, async function generateTTS_inner() {
            const text = document.getElementById('ttsText').value.trim();
            const profile = ttsProfileSel.value;
            const temperature = parseFloat(document.getElementById('temperature').value);
            if (!text) { showToast('Please enter some text.', 'error'); return; }

            const response = await fetch('/voice_clone/text_to_speech', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    text,
                    profile_name: profile,
                    exaggeration: 0.5,
                    cfg_weight: 0.5,
                    temperature,
                    seed_num: 0,
                    min_p: 0.05,
                    top_p: 1.0,
                    repetition_penalty: 1.2
                })
            });

            if (!response.ok) {
                showToast(await response.text(), 'error');
                return;
            }

            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            document.getElementById('ttsAudio').src = url;
            showToast('Speech generated successfully.', 'success');
            savePrefs();
        });

        async function generateTTS() { return _generateTTS(); }

        const _convertVoice = withLoading(btnVC, async function convertVoice_inner() {
            const fileInput = document.getElementById('vcFile');
            const file = fileInput.files[0];
            const profile = vcProfileSel.value;
            if (!file) { showToast('Please select an audio file.', 'error'); return; }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('profile_name', profile);

            const response = await fetch('/voice_clone/speech_to_speech', { method: 'POST', body: formData });
            if (!response.ok) { showToast(await response.text(), 'error'); return; }

            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            document.getElementById('vcAudio').src = url;
            showToast('Voice converted successfully.', 'success');
            savePrefs();
        });

        async function convertVoice() { return _convertVoice(); }

        const _saveProfile = withLoading(btnSave, async function saveProfile_inner() {
            const profileName = (document.getElementById('profileName').value || '').trim().toLowerCase();
            const fileInput = document.getElementById('profileFile');
            const file = fileInput.files[0];
            if (!file || !profileName) { showToast('Please provide a profile name and upload a file.', 'error'); return; }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('profile_name', profileName);  // ‚Üê CHANGED: profile_name, not profile_id

            const response = await fetch('/voice_clone/voice_save', { method: 'POST', body: formData });
            if (response.ok) {
                const data = await response.json();
                showToast(`Saved profile "${data.profile_name}".`, 'success');
                // Reload profiles to update dropdowns
                await loadProfiles();
                resetSaveForm();
            } else {
                const errorText = await response.text();
                showToast(`Save failed: ${errorText}`, 'error');
            }
        });

        async function saveProfile() { return _saveProfile(); }

        function resetSaveForm() {
            document.getElementById('profileName').value = '';
            document.getElementById('profileFile').value = '';
        }

        // Init on load
        document.addEventListener('DOMContentLoaded', () => {
            loadProfiles();
        });
    </script>
</body>
</html>