<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Text to Speech</title>
  <style>
    :root {
      --bg: #0f172a;
      --bg-soft: #111827;
      --card: #111827;
      --muted: #9ca3af;
      --text: #e5e7eb;
      --primary: #6366f1;
      --primary-600: #5457ee;
      --success: #10b981;
      --danger: #ef4444;
      --border: #1f2937;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 0; font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--text); background: radial-gradient(1200px 800px at 20% -10%, #1f2937 0, transparent 60%),
      radial-gradient(1000px 700px at 100% 0%, #1f2937 0, transparent 60%), var(--bg);
      min-height: 100vh;
    }
    .container { max-width: 900px; margin: 0 auto; padding: 24px; }
    header { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; }
    .brand-logo { width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary), #22d3ee); border-radius: 10px; box-shadow: 0 10px 30px rgba(34, 211, 238, .2); }
    h1 { font-size: 22px; margin: 0; letter-spacing: .3px; }
    .subtitle { color: var(--muted); font-size: 13px; margin-top: 4px; }

    .card { background: rgba(17,24,39,.9); border: 1px solid var(--border); border-radius: 14px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.35); backdrop-filter: blur(6px); margin-bottom: 20px; }
    .card h2 { margin: 0 0 12px; font-size: 18px; }
    .card p.hint { margin: 6px 0 16px; color: var(--muted); font-size: 13px; }

    .form-row { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 640px) { .form-row { grid-template-columns: 1fr 1fr; } }
    .form-group { display: flex; flex-direction: column; gap: 6px; }
    label { font-size: 13px; color: var(--muted); }
    input[type="text"], select { background: #0b1220; color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px; outline: none; transition: border .2s ease, box-shadow .2s ease; }
    input[type="text"]:focus, select:focus { border-color: #334155; box-shadow: 0 0 0 3px rgba(99, 102, 241, .15); }

    .actions { display: flex; gap: 12px; margin-top: 12px; }
    button { border: 0; background: var(--primary); color: white; padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 600; letter-spacing: .2px; display: inline-flex; align-items: center; gap: 10px; transition: background .2s ease, transform .06s ease; }
    button.secondary { background: #1f2937; color: var(--text); border: 1px solid var(--border); font-weight: 500; }
    button:hover { background: var(--primary-600); }
    button:active { transform: translateY(1px); }
    button[disabled] { opacity: .6; cursor: not-allowed; }
    .spinner { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,.35); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .audio-wrap { margin-top: 12px; background: #0b1220; border: 1px solid var(--border); border-radius: 12px; padding: 12px; }
    audio { width: 100%; height: 36px; }
    textarea {
      background: #0b1220;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      outline: none;
      transition: border .2s ease, box-shadow .2s ease;
      font-family: inherit;
      font-size: 15px;
      resize: vertical;
    }
    textarea:focus {
      border-color: #334155;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, .15);
    }
    .toast { position: fixed; right: 20px; bottom: 20px; background: #1f2937; color: var(--text); border: 1px solid var(--border); border-left: 4px solid var(--primary); padding: 12px 14px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,.35); display: none; min-width: 260px; }
    .toast.success { border-left-color: var(--success); }
    .toast.error { border-left-color: var(--danger); }

    .advanced { display: none; margin-top: 14px; padding-top: 12px; border-top: 1px dashed var(--border); }
    .toggle-advanced { font-size: 13px; color: var(--primary); cursor: pointer; margin-top: 8px; user-select: none; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand-logo"></div>
      <div>
        <h1>Text to Speech</h1>
        <div class="subtitle">Generate speech with adjustable parameters</div>
      </div>
    </header>

    <!-- Text to Speech -->
    <section class="card">
      <h2>üó£Ô∏è Text ‚Üí Speech</h2>
      <p class="hint">Enter text, pick a voice, and (optionally) adjust parameters.</p>

      <div class="form-group">
        <label for="ttsText">Text</label>
        <textarea id="ttsText" placeholder="Type something..." rows="4" style="resize:vertical; min-height:60px; font-size:15px;">Hello, this is a Voice Test.</textarea>
      </div>

      <div class="form-group">
        <label for="ttsProfile">Voice Profile</label>
        <div style="display: flex; align-items: center; gap: 10px;">
          <select id="ttsProfile"></select>
          <!-- <button type="button" id="btnPlayProfile" title="Play original voice" onclick="playProfileAudio()" style="padding: 6px 10px; font-size: 15px;">
            ‚ñ∂Ô∏è
          </button> -->
        </div>
        <audio id="profileAudio" style="margin-top: 6px; width: 100%;" controls hidden></audio>
      </div>

      <!-- Advanced Options -->
      <div class="toggle-advanced" onclick="toggleAdvanced()">‚öôÔ∏è Advanced Options</div>
      <div class="advanced" id="advancedOptions">
        <div class="form-row">
          <div class="form-group">
            <label for="temperature">Temperature</label>
            <input type="text" id="temperature" value="0.8">
          </div>
          <div class="form-group">
            <label for="exaggeration">Exaggeration</label>
            <input type="text" id="exaggeration" value="0.5">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="cfgWeight">CFG Weight</label>
            <input type="text" id="cfgWeight" value="0.5">
          </div>
          <div class="form-group">
            <label for="seedNum">Seed Number</label>
            <input type="text" id="seedNum" value="0">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="minP">Min P</label>
            <input type="text" id="minP" value="0.05">
          </div>
          <div class="form-group">
            <label for="topP">Top P</label>
            <input type="text" id="topP" value="1.0">
          </div>
        </div>
        <div class="form-group">
          <label for="repPenalty">Repetition Penalty</label>
          <input type="text" id="repPenalty" value="1.2">
        </div>
      </div>

      <div class="actions">
        <button id="btnTTS" onclick="generateTTS()"><span>Generate Speech</span></button>
        <button class="secondary" onclick="clearAudio('ttsAudio')">Clear</button>
      </div>

      <div class="audio-wrap">
        <audio id="ttsAudio" controls></audio>
      </div>
    </section>

    <!-- Save Voice Profile -->
    <section class="card">
      <h2>üíæ Save New Voice Profile</h2>
      <p class="hint">Upload a voice sample and give it a simple name (e.g., ‚Äúalice‚Äù, ‚Äúbob‚Äù).</p>
      <div class="form-row">
        <div class="form-group">
          <label for="profileName">Profile Name</label>
          <input type="text" id="profileName" placeholder="e.g., alice" autocomplete="off">
        </div>
        <div class="form-group">
          <label for="profileFile">Voice Sample (.wav, .mp3, .flac, .aac)</label>
          <input type="file" id="profileFile" accept="audio/*">
        </div>
      </div>
      <div class="actions">
        <button id="btnSave" onclick="saveProfile()"><span>Save Profile</span></button>
        <button class="secondary" onclick="resetSaveForm()">Reset</button>
      </div>
      <div class="note" id="saveHint">Tip: Use lowercase letters and avoid spaces for best compatibility.</div>
    </section>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const btnTTS = document.getElementById('btnTTS');
    const ttsProfileSel = document.getElementById('ttsProfile');
    const btnSave = document.getElementById('btnSave');

    function toggleAdvanced() {
      const adv = document.getElementById('advancedOptions');
      adv.style.display = adv.style.display === 'block' ? 'none' : 'block';
    }

    function showToast(message, type='info') {
      const el = document.getElementById('toast');
      el.className = 'toast';
      if (type==='success') el.classList.add('success');
      if (type==='error') el.classList.add('error');
      el.textContent = message;
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 2500);
    }

    function withLoading(buttonEl, fn) {
      return async (...args) => {
        const original = buttonEl.innerHTML;
        buttonEl.setAttribute('disabled', 'true');
        buttonEl.innerHTML = '<span class="spinner"></span><span>Working...</span>';
        try { return await fn(...args); }
        finally {
          buttonEl.removeAttribute('disabled');
          buttonEl.innerHTML = original;
        }
      }
    }

    function clearAudio(id) {
      const el = document.getElementById(id);
      el.removeAttribute('src');
      el.load();
    }

    async function loadProfiles() {
      const res = await fetch('/voice_profiles');
      if (!res.ok) return;
      const data = await res.json();
      ttsProfileSel.innerHTML = '';
      data.profiles.forEach(profile => {
        let opt = document.createElement('option');
        opt.value = profile;
        opt.textContent = profile.charAt(0).toUpperCase() + profile.slice(1);
        ttsProfileSel.appendChild(opt);
      });
      updateProfileAudio();
    }
    window.addEventListener('DOMContentLoaded', loadProfiles);

    const _generateTTS = withLoading(btnTTS, async function() {
      const text = document.getElementById('ttsText').value.trim();
      const profile = ttsProfileSel.value;
      if (!text) { showToast('Please enter text.', 'error'); return; }

      const body = {
        text,
        profile_name: profile,
        exaggeration: parseFloat(document.getElementById('exaggeration').value),
        cfg_weight: parseFloat(document.getElementById('cfgWeight').value),
        temperature: parseFloat(document.getElementById('temperature').value),
        seed_num: parseInt(document.getElementById('seedNum').value),
        min_p: parseFloat(document.getElementById('minP').value),
        top_p: parseFloat(document.getElementById('topP').value),
        repetition_penalty: parseFloat(document.getElementById('repPenalty').value)
      };

      const response = await fetch('/voice_clone/text_to_speech', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      if (!response.ok) {
        showToast(await response.text(), 'error');
        return;
      }

      const blob = await response.blob();
      document.getElementById('ttsAudio').src = URL.createObjectURL(blob);
      showToast('Speech generated.', 'success');
    });

    async function generateTTS() { return _generateTTS(); }

    const _saveProfile = withLoading(btnSave, async function() {
      const profileName = (document.getElementById('profileName').value || '').trim().toLowerCase();
      const fileInput = document.getElementById('profileFile');
      const file = fileInput.files[0];
      if (!file || !profileName) { showToast('Please provide a profile name and file.', 'error'); return; }

      const formData = new FormData();
      formData.append('file', file);
      formData.append('profile_name', profileName);

      const response = await fetch('/voice_clone/voice_save', { method: 'POST', body: formData });
      if (response.ok) {
        const data = await response.json();
        showToast(`Saved profile "${data.profile_name}".`, 'success');
        await loadProfiles();
        ttsProfileSel.value = data.profile_name;
        updateProfileAudio();
        resetSaveForm();
      } else {
        showToast(`Save failed: ${await response.text()}`, 'error');
      }
    });

    async function saveProfile() { return _saveProfile(); }

    function resetSaveForm() {
      document.getElementById('profileName').value = '';
      document.getElementById('profileFile').value = '';
    }

    // === Added functions for playing original voice ===
    function updateProfileAudio() {
      const profile = document.getElementById('ttsProfile').value;
      const audio = document.getElementById('profileAudio');
      if (!profile) {
        audio.hidden = true;
        audio.src = '';
        return;
      }
      audio.src = `/voice_profiles/${profile}/audio`;
      audio.hidden = false;
    }

    function playProfileAudio() {
      const audio = document.getElementById('profileAudio');
      if (audio.src) {
        audio.play();
      }
    }

    document.getElementById('ttsProfile').addEventListener('change', updateProfileAudio);
    window.addEventListener('DOMContentLoaded', () => {
      setTimeout(updateProfileAudio, 500);
    });
  </script>
</body>
</html>
