<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Voice Clone Studio</title>
    <style>
        :root {
            --bg: #0f172a;
            --bg-soft: #111827;
            --card: #111827;
            --muted: #9ca3af;
            --text: #e5e7eb;
            --primary: #6366f1;
            --primary-600: #5457ee;
            --success: #10b981;
            --danger: #ef4444;
            --border: #1f2937;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0; padding: 0; font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            color: var(--text); background: radial-gradient(1200px 800px at 20% -10%, #1f2937 0, transparent 60%),
            radial-gradient(1000px 700px at 100% 0%, #1f2937 0, transparent 60%), var(--bg);
            min-height: 100vh;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
        header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
        .brand { display: flex; align-items: center; gap: 12px; }
        .brand-logo { width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary), #22d3ee); border-radius: 10px; box-shadow: 0 10px 30px rgba(34, 211, 238, .2); }
        h1 { font-size: 22px; margin: 0; letter-spacing: .3px; }
        .subtitle { color: var(--muted); font-size: 13px; margin-top: 4px; }

        .grid { display: grid; grid-template-columns: 1fr; gap: 24px; }
        @media (min-width: 1024px) { .grid { grid-template-columns: 1fr 1fr; } }

        .card { background: rgba(17,24,39,.9); border: 1px solid var(--border); border-radius: 14px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,.35); backdrop-filter: blur(6px); }
        .card h2 { margin: 0 0 8px; font-size: 18px; display: flex; align-items: center; gap: 8px; }
        .card p.hint { margin: 0 0 20px; color: var(--muted); font-size: 13px; }

        .form-row { display: grid; grid-template-columns: 1fr; gap: 16px; }
        @media (min-width: 640px) { .form-row { grid-template-columns: 1fr 1fr; } }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        label { font-size: 13px; color: var(--muted); }
        input[type="text"], input[type="number"], select { background: #0b1220; color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px; outline: none; transition: border .2s ease, box-shadow .2s ease; width: 100%; }
        input[type="text"]:focus, input[type="number"]:focus, select:focus { border-color: #334155; box-shadow: 0 0 0 3px rgba(99, 102, 241, .15); }
        
        .actions { display: flex; gap: 12px; margin-top: 20px; }
        button { border: 0; background: var(--primary); color: white; padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 600; letter-spacing: .2px; display: inline-flex; align-items: center; justify-content: center; gap: 10px; transition: background .2s ease, transform .06s ease; }
        button.secondary { background: #1f2937; color: var(--text); border: 1px solid var(--border); font-weight: 500; }
        button:hover { background: var(--primary-600); }
        button:active { transform: translateY(1px); }
        button[disabled] { opacity: .6; cursor: not-allowed; }
        .spinner { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,.35); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .audio-wrap { margin-top: 16px; background: #0b1220; border: 1px solid var(--border); border-radius: 12px; padding: 12px; }
        audio { width: 100%; height: 36px; }

        .toast { position: fixed; right: 20px; bottom: 20px; background: #1f2937; color: var(--text); border: 1px solid var(--border); border-left: 4px solid var(--primary); padding: 12px 14px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,.35); display: none; min-width: 260px; z-index: 100; }
        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--danger); }
        .note { color: var(--muted); font-size: 12px; margin-top: 8px; }
        .pill { display: inline-block; padding: 4px 8px; border-radius: 999px; background: #0b1220; border: 1px solid var(--border); color: var(--muted); font-size: 12px; }

        /* NEW: Slider Styles */
        .slider-group { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 12px; }
        .slider-group label { margin: 0; }
        .slider-group .value-display { font-size: 13px; font-weight: 500; color: var(--text); background: #0b1220; padding: 4px 8px; border-radius: 6px; min-width: 40px; text-align: center; }
        input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 6px; background: #1f2937; border-radius: 3px; outline: none; grid-column: 1 / -1; margin-top: 4px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; background: var(--primary); border-radius: 50%; cursor: pointer; transition: background .2s ease; }
        input[type="range"]::-moz-range-thumb { width: 16px; height: 16px; background: var(--primary); border-radius: 50%; cursor: pointer; border: 0; transition: background .2s ease; }
        input[type="range"]::-webkit-slider-thumb:hover { background: var(--primary-600); }
        input[type="range"]::-moz-range-thumb:hover { background: var(--primary-600); }

        /* NEW: Profile selection with play button */
        .profile-selector { display: flex; align-items: center; gap: 8px; }
        .profile-selector select { flex-grow: 1; }
        .play-btn { background: none; border: 1px solid var(--border); color: var(--muted); padding: 8px; border-radius: 8px; cursor: pointer; line-height: 0; }
        .play-btn:hover { background: #1f2937; color: var(--text); }

        /* NEW: Recording Styles */
        .file-input-group { display: flex; flex-direction: column; gap: 12px; }
        .file-input-group .or-divider { text-align: center; color: var(--muted); font-size: 12px; }
        .record-status { display: none; align-items: center; gap: 8px; font-size: 13px; color: var(--danger); margin-top: 8px; }
        .record-status.active { display: flex; }
        .record-dot { width: 8px; height: 8px; background: var(--danger); border-radius: 50%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="container">
        <header>
            <div class="brand">
                <div class="brand-logo"></div>
                <div>
                    <h1>Voice Clone Studio</h1>
                    <div class="subtitle">Generate speech, convert voices, and manage profiles</div>
                </div>
            </div>
            <div class="pill" id="profileCount">Profiles: ‚Äî</div>
        </header>

        <div class="grid">
            <!-- Text to Speech Card -->
            <section class="card" id="ttsCard">
                <h2>üó£Ô∏è Text ‚Üí Speech</h2>
                <p class="hint">Enter text, select a voice, and fine-tune the generation parameters.</p>
                
                <div class="form-group">
                    <label for="ttsText">Text</label>
                    <input type="text" id="ttsText" placeholder="Type what you want the voice to say" value="Hello, this is a test of the advanced voice generation system.">
                </div>
                
                <div class="form-group">
                    <label for="ttsProfile">Voice Profile</label>
                    <div class="profile-selector">
                        <select id="ttsProfile"></select>
                        <button class="play-btn" onclick="playProfileSample('ttsProfile')" title="Play original voice sample">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                        </button>
                    </div>
                </div>

                <details>
                    <summary style="cursor: pointer; color: var(--muted); font-size: 14px; margin-top: 16px;">Advanced Settings</summary>
                    <div class="form-row" style="margin-top: 16px;">
                        <!-- All new sliders for TTS -->
                        <div class="form-group">
                            <div class="slider-group">
                                <label for="exaggeration">Expressiveness</label>
                                <span class="value-display" id="exaggeration-val">0.5</span>
                            </div>
                            <input type="range" id="exaggeration" min="0.25" max="2.0" step="0.05" value="0.5">
                        </div>
                        <div class="form-group">
                            <div class="slider-group">
                                <label for="cfg_weight">Clarity vs. Pace</label>
                                <span class="value-display" id="cfg_weight-val">0.5</span>
                            </div>
                            <input type="range" id="cfg_weight" min="0.0" max="1.0" step="0.05" value="0.5">
                        </div>
                        <div class="form-group">
                            <div class="slider-group">
                                <label for="temperature">Creativity</label>
                                <span class="value-display" id="temperature-val">0.8</span>
                            </div>
                            <input type="range" id="temperature" min="0.05" max="5.0" step="0.05" value="0.8">
                        </div>
                        <div class="form-group">
                            <div class="slider-group">
                                <label for="repetition_penalty">Repetition Penalty</label>
                                <span class="value-display" id="repetition_penalty-val">1.2</span>
                            </div>
                            <input type="range" id="repetition_penalty" min="1.0" max="2.0" step="0.05" value="1.2">
                        </div>
                        <div class="form-group">
                            <label for="seed_num">Seed (0 for random)</label>
                            <input type="number" id="seed_num" value="0">
                        </div>
                    </div>
                </details>

                <div class="actions">
                    <button id="btnTTS" onclick="generateTTS()">
                        <span>Generate Speech</span>
                    </button>
                    <button class="secondary" onclick="clearAudio('ttsAudio')">Clear</button>
                </div>
                <div class="audio-wrap">
                    <audio id="ttsAudio" controls></audio>
                </div>
            </section>

            <!-- Speech to Speech Card -->
            <section class="card" id="vcCard">
                <h2>üîÅ Speech ‚Üí Speech</h2>
                <p class="hint">Upload or record source audio and convert it into the target voice.</p>
                <div class="form-row">
                    <div class="form-group">
                        <label>Source Audio</label>
                        <div class="file-input-group">
                            <input type="file" id="vcFile" accept="audio/*">
                            <div class="or-divider">or</div>
                            <button class="secondary" id="btnRecordVC" onclick="toggleRecording('vc')">Record Audio</button>
                            <div class="record-status" id="recordStatusVC">
                                <div class="record-dot"></div>
                                <span>Recording...</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="vcProfile">Target Voice</label>
                        <div class="profile-selector">
                            <select id="vcProfile"></select>
                            <button class="play-btn" onclick="playProfileSample('vcProfile')" title="Play original voice sample">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="actions">
                    <button id="btnVC" onclick="convertVoice()">
                        <span>Convert Voice</span>
                    </button>
                    <button class="secondary" onclick="clearAudio('vcAudio')">Clear</button>
                </div>
                <div class="audio-wrap">
                    <audio id="vcAudio" controls></audio>
                </div>
            </section>

            <!-- Save Profile Card -->
            <section class="card" id="saveCard" style="grid-column: 1 / -1;">
                <h2>üíæ Save New Voice Profile</h2>
                <p class="hint">Upload or record a clean voice sample (5-20 seconds is ideal) and give it a simple name.</p>
                <div class="form-row">
                    <div class="form-group">
                        <label for="profileName">Profile Name</label>
                        <input type="text" id="profileName" placeholder="e.g., alice" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label>Voice Sample (.wav, .mp3)</label>
                        <div class="file-input-group">
                            <input type="file" id="profileFile" accept="audio/*">
                            <div class="or-divider">or</div>
                            <button class="secondary" id="btnRecordSave" onclick="toggleRecording('save')">Record Audio</button>
                             <div class="record-status" id="recordStatusSave">
                                <div class="record-dot"></div>
                                <span>Recording...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="actions">
                    <button id="btnSave" onclick="saveProfile()">
                        <span>Save Profile</span>
                    </button>
                    <button class="secondary" onclick="resetSaveForm()">Reset</button>
                </div>
                <div class="note" id="saveHint">Tip: Use lowercase letters and avoid spaces for best compatibility.</div>
            </section>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // --- DOM Elements ---
        const btnTTS = document.getElementById('btnTTS');
        const btnVC = document.getElementById('btnVC');
        const btnSave = document.getElementById('btnSave');
        const ttsProfileSel = document.getElementById('ttsProfile');
        const vcProfileSel = document.getElementById('vcProfile');
        const profileCount = document.getElementById('profileCount');

        // --- State Management ---
        let recordedBlobs = { vc: null, save: null };
        let mediaRecorder;
        let isRecording = false;
        let currentRecordingType = null;

        // --- Utility Functions ---
        function showToast(message, type = 'info') {
            const el = document.getElementById('toast');
            el.className = 'toast';
            if (type === 'success') el.classList.add('success');
            if (type === 'error') el.classList.add('error');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => { el.style.display = 'none'; }, 3000);
        }

        function withLoading(buttonEl, fn) {
            return async (...args) => {
                const original = buttonEl.innerHTML;
                buttonEl.setAttribute('disabled', 'true');
                buttonEl.innerHTML = '<span class="spinner"></span><span>Working...</span>';
                try {
                    await fn(...args);
                } catch (e) {
                    showToast(e.message || 'An unknown error occurred.', 'error');
                } finally {
                    buttonEl.removeAttribute('disabled');
                    buttonEl.innerHTML = original;
                }
            }
        }

        function clearAudio(id) {
            const el = document.getElementById(id);
            el.removeAttribute('src');
            el.load();
        }

        // --- NEW: Recording Logic ---
        async function toggleRecording(type) {
            if (isRecording) {
                stopRecording();
                return;
            }
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                isRecording = true;
                currentRecordingType = type;
                
                const recordButton = document.getElementById(type === 'vc' ? 'btnRecordVC' : 'btnRecordSave');
                recordButton.textContent = 'Stop Recording';
                recordButton.style.color = 'var(--danger)';
                document.getElementById(`recordStatus${type.toUpperCase()}`).classList.add('active');

                const chunks = [];
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = e => chunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'audio/wav' });
                    recordedBlobs[type] = blob;
                    stream.getTracks().forEach(track => track.stop());
                    isRecording = false;
                    recordButton.textContent = 'Record Audio';
                    recordButton.style.color = '';
                    document.getElementById(`recordStatus${type.toUpperCase()}`).classList.remove('active');
                    showToast(`Recording finished. Ready to use.`, 'success');
                };
                mediaRecorder.start();
            } catch (err) {
                showToast('Could not access microphone. Please grant permission.', 'error');
                console.error("Microphone access error:", err);
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
        }

        // --- Profile Management ---
        async function loadProfiles() {
            try {
                const res = await fetch('/voice_profiles');
                if (!res.ok) throw new Error(`Server error: ${res.status}`);
                const data = await res.json();
                
                profileCount.textContent = `Profiles: ${data.profiles.length}`;
                
                // Clear existing options
                ttsProfileSel.innerHTML = '';
                vcProfileSel.innerHTML = '';

                if (data.profiles.length === 0) {
                    const defaultOption = new Option("No profiles found", "", true, true);
                    defaultOption.disabled = true;
                    ttsProfileSel.add(defaultOption.cloneNode(true));
                    vcProfileSel.add(defaultOption);
                    return;
                }

                for (const profileName of data.profiles) {
                    const optionText = profileName.charAt(0).toUpperCase() + profileName.slice(1);
                    ttsProfileSel.add(new Option(optionText, profileName));
                    vcProfileSel.add(new Option(optionText, profileName));
                }
                loadPrefs();
            } catch (e) {
                showToast(`Failed to load profiles: ${e.message}`, 'error');
            }
        }

        // --- NEW: Play Voice Sample ---
        const _playProfileSample = withLoading(document.body, async function(selectId) {
            const selectEl = document.getElementById(selectId);
            const profileName = selectEl.value;
            if (!profileName) {
                showToast('Please select a profile first.', 'error');
                return;
            }
            try {
                const res = await fetch(`/voice_clone/voice_fetch?profile_name=${encodeURIComponent(profileName)}`);
                if (!res.ok) throw new Error(`Could not fetch audio for "${profileName}"`);
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                new Audio(url).play();
            } catch (e) {
                showToast(e.message, 'error');
            }
        });
        async function playProfileSample(selectId) { return _playProfileSample(selectId); }


        // --- API Call Functions ---
        const _generateTTS = withLoading(btnTTS, async function() {
            const payload = {
                text: document.getElementById('ttsText').value.trim(),
                profile_name: ttsProfileSel.value,
                exaggeration: parseFloat(document.getElementById('exaggeration').value),
                cfg_weight: parseFloat(document.getElementById('cfg_weight').value),
                temperature: parseFloat(document.getElementById('temperature').value),
                repetition_penalty: parseFloat(document.getElementById('repetition_penalty').value),
                seed_num: parseInt(document.getElementById('seed_num').value, 10),
                min_p: 0.05, // These can be added as sliders too if needed
                top_p: 1.0,
            };

            if (!payload.text) { showToast('Please enter some text.', 'error'); return; }
            if (!payload.profile_name) { showToast('Please select a voice profile.', 'error'); return; }

            const response = await fetch('/voice_clone/text_to_speech', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorText = await response.text();
                showToast(`Generation failed: ${errorText}`, 'error');
                return;
            }

            const blob = await response.blob();
            document.getElementById('ttsAudio').src = URL.createObjectURL(blob);
            showToast('Speech generated successfully.', 'success');
            savePrefs();
        });
        async function generateTTS() { return _generateTTS(); }

        const _convertVoice = withLoading(btnVC, async function() {
            const fileInput = document.getElementById('vcFile');
            const file = recordedBlobs.vc ? new File([recordedBlobs.vc], "recording.wav", { type: "audio/wav" }) : fileInput.files[0];
            const profile = vcProfileSel.value;

            if (!file) { showToast('Please select or record an audio file.', 'error'); return; }
            if (!profile) { showToast('Please select a target voice profile.', 'error'); return; }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('profile_name', profile);

            const response = await fetch('/voice_clone/speech_to_speech', { method: 'POST', body: formData });
            if (!response.ok) { showToast(await response.text(), 'error'); return; }

            const blob = await response.blob();
            document.getElementById('vcAudio').src = URL.createObjectURL(blob);
            showToast('Voice converted successfully.', 'success');
            recordedBlobs.vc = null; // Clear after use
            fileInput.value = '';
        });
        async function convertVoice() { return _convertVoice(); }

        const _saveProfile = withLoading(btnSave, async function() {
            const profileName = (document.getElementById('profileName').value || '').trim().toLowerCase();
            const fileInput = document.getElementById('profileFile');
            const file = recordedBlobs.save ? new File([recordedBlobs.save], "recording.wav", { type: "audio/wav" }) : fileInput.files[0];

            if (!file || !profileName) { showToast('Please provide a profile name and a voice sample.', 'error'); return; }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('profile_name', profileName);

            const response = await fetch('/voice_clone/voice_save', { method: 'POST', body: formData });
            if (response.ok) {
                const data = await response.json();
                showToast(`Saved profile "${data.profile_name}".`, 'success');
                await loadProfiles();
                resetSaveForm();
            } else {
                showToast(`Save failed: ${await response.text()}`, 'error');
            }
        });
        async function saveProfile() { return _saveProfile(); }

        function resetSaveForm() {
            document.getElementById('profileName').value = '';
            document.getElementById('profileFile').value = '';
            recordedBlobs.save = null;
        }

        // --- Preferences & Initialization ---
        function savePrefs() {
            const prefs = {
                ttsProfile: ttsProfileSel.value,
                vcProfile: vcProfileSel.value,
                ttsText: document.getElementById('ttsText').value,
                exaggeration: document.getElementById('exaggeration').value,
                cfg_weight: document.getElementById('cfg_weight').value,
                temperature: document.getElementById('temperature').value,
                repetition_penalty: document.getElementById('repetition_penalty').value,
                seed_num: document.getElementById('seed_num').value,
            };
            localStorage.setItem('vc_prefs', JSON.stringify(prefs));
        }

        function loadPrefs() {
            try {
                const raw = localStorage.getItem('vc_prefs');
                if (!raw) return;
                const prefs = JSON.parse(raw);
                if (prefs.ttsText) document.getElementById('ttsText').value = prefs.ttsText;
                if (prefs.ttsProfile) ttsProfileSel.value = prefs.ttsProfile;
                if (prefs.vcProfile) vcProfileSel.value = prefs.vcProfile;
                
                // Load slider values
                ['exaggeration', 'cfg_weight', 'temperature', 'repetition_penalty', 'seed_num'].forEach(id => {
                    if (prefs[id]) {
                        const el = document.getElementById(id);
                        el.value = prefs[id];
                        if (el.type === 'range') {
                            document.getElementById(`${id}-val`).textContent = prefs[id];
                        }
                    }
                });
            } catch {}
        }

        function setupSliderListeners() {
            document.querySelectorAll('input[type="range"]').forEach(slider => {
                const display = document.getElementById(`${slider.id}-val`);
                if (display) {
                    slider.addEventListener('input', () => {
                        display.textContent = slider.value;
                    });
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadProfiles();
            setupSliderListeners();
        });
    </script>
</body>
</html>