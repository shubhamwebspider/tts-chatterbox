<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üó£Ô∏è</text></svg>">
  <title>Text to Speech</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f172a;
      --bg-soft: #111827;
      --card: #111827;
      --muted: #9ca3af;
      --text: #e5e7eb;
      --primary: #6366f1;
      --primary-light: #818cf8;
      --primary-dark: #4f46e5;
      --primary-gradient: linear-gradient(135deg, #6366f1, #8b5cf6);
      --secondary-accent: #8b5cf6;
      --success: #10b981;
      --danger: #ef4444;
      --border: #1f2937;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 0; 
      font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--text); 
      background: radial-gradient(1200px 800px at 20% -10%, rgba(31, 41, 55, 0.3) 0, transparent 60%),
      radial-gradient(1000px 700px at 100% 0%, rgba(31, 41, 55, 0.2) 0, transparent 60%), var(--bg);
      min-height: 100vh;
      line-height: 1.6;
    }
    .container { 
      max-width: 900px; 
      margin: 0 auto; 
      padding: 32px 24px; 
    }
    header { 
      display: flex; 
      align-items: center; 
      gap: 16px; 
      margin-bottom: 32px; 
    }
    .brand-logo { 
      width: 44px; 
      height: 44px; 
      background: var(--primary-gradient);
      border-radius: 12px; 
      box-shadow: 0 10px 30px rgba(99, 102, 241, .25); 
      position: relative;
      overflow: hidden;
    }
    .brand-logo::after {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 20px;
      height: 20px;
      background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M3.5 18.49l6.26 2.86c.66.3 1.44.3 2.1 0l6.26-2.86A2 2 0 0019.5 17V7a2 2 0 00-1.12-1.79l-6.26-2.86a2.08 2.08 0 00-2.1 0L3.62 5.21A2 2 0 002.5 7v10a2 2 0 001 1.49zM11.5 12.5v-5h2v5a1 1 0 11-2 0zm0 3h2v2h-2v-2z"/></svg>') no-repeat center;
      background-size: contain;
      opacity: 0.8;
    }
    h1 { 
      font-size: 32px; 
      font-weight: 700;
      margin: 0; 
      letter-spacing: -.5px;
      background: linear-gradient(to right, var(--text), var(--primary-light));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .subtitle { 
      color: var(--muted); 
      font-size: 15px; 
      font-weight: 400;
      margin-top: 6px; 
      line-height: 1.5;
    }

    .card { 
      background: rgba(17,24,39,.85); 
      border: 1px solid rgba(31, 41, 55, 0.6); 
      border-radius: 16px; 
      padding: 24px; 
      box-shadow: 0 8px 32px rgba(0,0,0,.2); 
      backdrop-filter: blur(8px); 
      margin-bottom: 28px; 
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0,0,0,.25);
    }
    .card h2 { 
      margin: 0 0 16px; 
      font-size: 22px; 
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .card h2 svg {
      width: 24px;
      height: 24px;
      fill: var(--primary);
    }
    .card p.hint { 
      margin: 6px 0 20px; 
      color: var(--muted); 
      font-size: 14px; 
      line-height: 1.5;
    }

    .form-row { 
      display: grid; 
      grid-template-columns: 1fr; 
      gap: 16px; 
      margin-bottom: 16px;
    }
    @media (min-width: 640px) { 
      .form-row { 
        grid-template-columns: 1fr 1fr; 
        gap: 20px;
      } 
    }
    .form-group { 
      display: flex; 
      flex-direction: column; 
      gap: 8px; 
    }
    label { 
      font-size: 14px; 
      color: var(--muted); 
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    label svg {
      width: 16px;
      height: 16px;
      stroke: var(--primary);
      fill: none;
      stroke-width: 1.5px;
    }
    input[type="text"], 
    input[type="number"],
    select, 
    textarea,
    input[type="file"] {
      background: #0b1220; 
      color: var(--text); 
      border: 1px solid var(--border); 
      border-radius: 12px; 
      padding: 12px 16px; 
      outline: none; 
      transition: all .25s ease; 
      font-family: inherit;
      font-size: 15px;
    }
    input[type="file"] {
        padding: 10px 12px;
    }
    input[type="text"]:focus, 
    input[type="number"]:focus,
    select:focus,
    textarea:focus,
    input[type="file"]:focus { 
      border-color: var(--primary); 
      box-shadow: 0 0 0 3px rgba(99, 102, 241, .25); 
      background: #111a2a;
    }
    input[type="text"]:hover,
    input[type="number"]:hover,
    select:hover,
    textarea:hover,
    input[type="file"]:hover {
      border-color: var(--primary-light);
    }

    .actions { 
      display: flex; 
      gap: 16px; 
      margin-top: 20px; 
      justify-content: flex-start;
      flex-wrap: wrap;
    }
    button { 
      border: 0; 
      background: var(--primary-gradient); 
      color: white; 
      padding: 12px 20px; 
      border-radius: 12px; 
      cursor: pointer; 
      font-weight: 600; 
      letter-spacing: .3px; 
      display: inline-flex; 
      align-items: center; 
      gap: 10px; 
      transition: all .2s ease; 
      font-size: 15px;
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    }
    button svg {
        stroke: white;
        fill: none;
        stroke-width: 2px;
    }
    button.secondary { 
      background: transparent; 
      color: var(--text); 
      border: 1px solid var(--border); 
      font-weight: 500; 
      box-shadow: none;
    }
    button.secondary svg {
        stroke: var(--text);
    }
    button.secondary:hover {
      background: rgba(31, 41, 55, 0.5);
      border-color: var(--primary-light);
    }
    button:hover { 
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
    }
    button:active { 
      transform: translateY(0); 
    }
    button[disabled] { 
      opacity: .6; 
      cursor: not-allowed; 
      transform: none;
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    }
    .spinner { 
      width: 18px; 
      height: 18px; 
      border: 2px solid rgba(255,255,255,.35); 
      border-top-color: white; 
      border-radius: 50%; 
      animation: spin 1s linear infinite; 
    }
    @keyframes spin { 
      to { transform: rotate(360deg); } 
    }

    .audio-wrap { 
      margin-top: 20px; 
      background: #0b1220; 
      border: 1px solid var(--border); 
      border-radius: 14px; 
      padding: 16px; 
      transition: all 0.3s ease;
    }
    .audio-wrap:hover {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
    }
    audio {
        width: 100%;
    }

    .toggle-advanced { 
      font-size: 14px; 
      color: var(--primary); 
      cursor: pointer; 
      margin-top: 16px; 
      user-select: none; 
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      transition: color 0.2s ease;
    }
    .toggle-advanced:hover {
      color: var(--primary-light);
    }
    .toggle-advanced svg {
      width: 18px;
      height: 18px;
      stroke: var(--primary);
      transition: transform 0.3s ease, stroke 0.2s ease;
    }
    .toggle-advanced:hover svg {
        stroke: var(--primary-light);
    }
    .advanced.active + .toggle-advanced svg {
      transform: rotate(45deg);
    }

    .advanced { 
      display: none; 
      margin-top: 20px; 
      padding-top: 20px; 
      border-top: 1px dashed rgba(31, 41, 55, 0.5);
    }
    .advanced.active {
      display: block;
    }

    .note {
      margin-top: 16px;
      padding: 12px;
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.2);
      border-radius: 10px;
      color: var(--success);
      font-size: 13px;
      line-height: 1.4;
    }

    .toast { 
      position: fixed; 
      right: 24px; 
      bottom: -100px; /* Start off-screen */
      background: #1f2937; 
      color: var(--text); 
      border: 1px solid var(--border); 
      border-left: 4px solid var(--primary); 
      padding: 16px 20px; 
      border-radius: 14px; 
      box-shadow: 0 10px 30px rgba(0,0,0,.4); 
      min-width: 280px;
      opacity: 0;
      transition: transform 0.4s ease, opacity 0.4s ease;
      z-index: 1000;
    }
    .toast.show {
        transform: translateY(-124px); /* bottom: 24px */
        opacity: 1;
    }
    .toast.success { 
      border-left-color: var(--success); 
      background: rgba(16, 185, 129, 0.15);
      border-color: rgba(16, 185, 129, 0.3);
    }
    .toast.error { 
      border-left-color: var(--danger); 
      background: rgba(239, 68, 68, 0.15);
      border-color: rgba(239, 68, 68, 0.3);
    }
    .profile-selector-wrapper audio {
      height: 32px;
      vertical-align: middle;
    }
    
    .profile-selector-wrapper {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .profile-select-col {
      flex: 1 1 60%;
      min-width: 0;
    }

    .profile-audio-col {
      flex: 1 1 40%;
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 0;
      justify-content: flex-end;
    }
    #ttsProfile {
        flex-grow: 1;
    }
    #btnDeleteProfile {
        padding: 10px;
        background: transparent;
        border: 1px solid var(--border);
        box-shadow: none;
        flex-shrink: 0;
    }
    #btnDeleteProfile svg {
        stroke: var(--muted);
        width: 20px;
        height: 20px;
        transition: stroke 0.2s ease;
    }
    #btnDeleteProfile:hover:not([disabled]) {
        background: rgba(239, 68, 68, 0.1);
        border-color: var(--danger);
    }
    #btnDeleteProfile:hover:not([disabled]) svg {
        stroke: var(--danger);
    }
    #btnDeleteProfile[disabled] {
        background: transparent;
        box-shadow: none;
    }

    /* --- New Slider Styles --- */
    .slider-container {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .slider-value {
      font-size: 14px;
      color: var(--text);
      background: #0b1220;
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid var(--border);
      min-width: 50px; /* Prevent layout shift */
      text-align: center;
      font-variant-numeric: tabular-nums;
    }
    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 18px;
      background: transparent;
      cursor: pointer;
      outline: none;
    }
    /* Webkit (Chrome, Safari) */
    input[type="range"]::-webkit-slider-runnable-track {
      width: 100%;
      height: 6px;
      background: #0b1220;
      border: 1px solid var(--border);
      border-radius: 6px;
      transition: border-color 0.2s ease;
    }
    input[type="range"]:hover::-webkit-slider-runnable-track {
      border-color: var(--primary-light);
    }
    input[type="range"]:focus::-webkit-slider-runnable-track {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, .25);
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      margin-top: -6px; /* (thumb height - track height) / 2 */
      width: 18px;
      height: 18px;
      background: var(--primary);
      border-radius: 50%;
      border: 2px solid var(--bg);
      transition: transform 0.2s ease, background-color 0.2s ease;
    }
    input[type="range"]:hover::-webkit-slider-thumb {
      background: var(--primary-light);
    }
    input[type="range"]:active::-webkit-slider-thumb {
      transform: scale(1.15);
    }
    /* Mozilla (Firefox) */
    input[type="range"]::-moz-range-track {
      width: 100%;
      height: 6px;
      background: #0b1220;
      border: 1px solid var(--border);
      border-radius: 6px;
      transition: border-color 0.2s ease;
    }
    input[type="range"]:hover::-moz-range-track {
      border-color: var(--primary-light);
    }
    input[type="range"]:focus::-moz-range-track {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, .25);
    }
    input[type="range"]::-moz-range-thumb {
      width: 14px; /* thumb width - border width * 2 */
      height: 14px;
      background: var(--primary);
      border-radius: 50%;
      border: 2px solid var(--bg);
      cursor: pointer;
      transition: transform 0.2s ease, background-color 0.2s ease;
    }
    input[type="range"]:hover::-moz-range-thumb {
      background: var(--primary-light);
    }
    input[type="range"]:active::-moz-range-thumb {
      transform: scale(1.15);
    }
    
    /* --- NEW STYLES for Record Button --- */
    .file-input-wrapper {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    #profileFile {
      flex-grow: 1;
    }
    #btnRecord {
      flex-shrink: 0;
      padding-left: 16px;
      padding-right: 16px;
    }
    #btnRecord.is-recording {
      background: var(--danger);
      border-color: var(--danger);
      color: white;
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
    }
    #btnRecord.is-recording svg {
      stroke: white;
      fill: white; /* Make the mic icon solid red when recording */
    }
    #btnRecord.is-recording:hover {
      background: #d03434; /* A slightly darker red for hover */
      border-color: #d03434;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand-logo"></div>
      <div>
        <h1>Text to Speech</h1>
        <div class="subtitle">Generate natural-sounding speech with adjustable parameters</div>
      </div>
    </header>

    <!-- Text to Speech -->
    <section class="card">
      <h2>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2h2v2a5 5 0 0 0 10 0v-2h2z"></path></svg>
        Text ‚Üí Speech
      </h2>
      <p class="hint">Enter text, pick a voice, and optionally adjust advanced parameters for fine-tuning.</p>

      <div class="form-group">
        <label for="ttsText">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
          Text
        </label>
        <textarea id="ttsText" placeholder="Type something..." rows="4" style="resize:vertical; min-height:80px;">Hello, this is a Voice Test.</textarea>
      </div>

      <div class="form-group">
        <label for="ttsProfile">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
          Voice Profile
        </label>
        <div class="profile-selector-wrapper">
            <select id="ttsProfile"></select>
            <audio id="profileAudio" controls style="display: none; width: 120px; margin: 0 8px;"></audio>
            <button id="btnDeleteProfile" title="Delete selected profile">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
            </button>
        </div>
      </div>

      <!-- Advanced Options -->
      <div class="advanced" id="advancedOptions">
        <div class="form-row">
          <div class="form-group">
            <label for="temperature">Temperature</label>
            <div class="slider-container">
              <input type="range" id="temperature" value="0.8" min="0.05" max="5.0" step="0.01" oninput="this.nextElementSibling.textContent = this.value">
              <span class="slider-value">0.8</span>
            </div>
            <small style="color:var(--muted);font-size:12px;">Controls creativity/variability. Range: 0.05‚Äì5.0 (default: 0.8)</small>
          </div>
          <div class="form-group">
            <label for="exaggeration">Exaggeration</label>
            <div class="slider-container">
              <input type="range" id="exaggeration" value="0.5" min="0.25" max="2.0" step="0.01" oninput="this.nextElementSibling.textContent = this.value">
              <span class="slider-value">0.5</span>
            </div>
            <small style="color:var(--muted);font-size:12px;">How expressive the speech is. Range: 0.25‚Äì2.0 (default: 0.5)</small>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="cfgWeight">CFG Weight</label>
            <div class="slider-container">
              <input type="range" id="cfgWeight" value="0.5" min="0.0" max="1.0" step="0.01" oninput="this.nextElementSibling.textContent = this.value">
              <span class="slider-value">0.5</span>
            </div>
            <small style="color:var(--muted);font-size:12px;">Clarity vs. pace. Higher = clearer but slower. Range: 0.0‚Äì1.0 (default: 0.5)</small>
          </div>
          <div class="form-group">
            <label for="seedNum">Seed Number</label>
            <input type="number" id="seedNum" value="0" min="0" step="1">
            <small style="color:var(--muted);font-size:12px;">Random seed. 0 = random, same number = same result.</small>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="minP">Min P</label>
            <div class="slider-container">
              <input type="range" id="minP" value="0.05" min="0.0" max="1.0" step="0.01" oninput="this.nextElementSibling.textContent = this.value">
              <span class="slider-value">0.05</span>
            </div>
            <small style="color:var(--muted);font-size:12px;">Model confidence. Range: 0.0‚Äì1.0 (default: 0.05)</small>
          </div>
          <div class="form-group">
            <label for="topP">Top P</label>
            <div class="slider-container">
              <input type="range" id="topP" value="1.0" min="0.0" max="1.0" step="0.01" oninput="this.nextElementSibling.textContent = this.value">
              <span class="slider-value">1.0</span>
            </div>
            <small style="color:var(--muted);font-size:12px;">Randomness. Range: 0.0‚Äì1.0 (default: 1.0)</small>
          </div>
        </div>
        <div class="form-group">
          <label for="repPenalty">Repetition Penalty</label>
          <div class="slider-container">
            <input type="range" id="repPenalty" value="1.2" min="1.0" max="2.0" step="0.01" oninput="this.nextElementSibling.textContent = this.value">
            <span class="slider-value">1.2</span>
          </div>
          <small style="color:var(--muted);font-size:12px;">Discourages repetition. Range: 1.0‚Äì2.0 (default: 1.2)</small>
        </div>
      </div>
      <div class="toggle-advanced" onclick="toggleAdvanced()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        Advanced Options
      </div>

      <div class="actions">
        <button id="btnTTS" onclick="generateTTS()">
          <span>Generate Speech</span>
        </button>
        <button class="secondary" onclick="clearAudio('ttsAudio')">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
          Clear
        </button>
      </div>

      <div class="audio-wrap">
        <audio id="ttsAudio" controls></audio>
      </div>
    </section>

    <!-- Save Voice Profile -->
    <section class="card">
      <h2>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21" stroke="var(--bg)" stroke-width="2" fill="none"></polyline><polyline points="7 3 7 8 15 8" stroke="var(--bg)" stroke-width="2" fill="none"></polyline></svg>
        Save New Voice Profile
      </h2>
      <p class="hint">Upload a voice sample and give it a simple name (e.g., "alice", "bob").</p>
      <div class="form-row">
        <div class="form-group">
          <label for="profileName">Profile Name</label>
          <input type="text" id="profileName" placeholder="e.g., alice" autocomplete="off">
        </div>
        <div class="form-group">
          <label for="profileFile">Voice Sample (.wav, .mp3, .flac, .aac)</label>
          <!-- NEW: Wrapper for file input and record button -->
          <div class="file-input-wrapper">
            <input type="file" id="profileFile" accept="audio/*">
            <button type="button" id="btnRecord" class="secondary" title="Record audio">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2h2v2a5 5 0 0 0 10 0v-2h2z"></path></svg>
              <span>Record</span>
            </button>
          </div>
        </div>
      </div>
      <div class="actions">
        <button id="btnSave" onclick="saveProfile()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
          <span>Save Profile</span>
        </button>
        <button class="secondary" onclick="resetSaveForm()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="16" height="16"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
          Reset
        </button>
      </div>

      <!-- NEW: Audio preview for uploaded/recorded file -->
      <div class="audio-wrap" id="profileUploadAudioWrapper" style="display: none;">
        <audio id="profileUploadAudio" controls></audio>
      </div>

      <div class="note" id="saveHint">Tip: Upload voice around 10 - 20 seconds and use lowercase letters and avoid spaces for best compatibility.</div>
    </section>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const btnTTS = document.getElementById('btnTTS');
    const ttsProfileSel = document.getElementById('ttsProfile');
    const btnSave = document.getElementById('btnSave');
    const btnDeleteProfile = document.getElementById('btnDeleteProfile');
    const PROTECTED_PROFILES = ['harry', 'sophie'];

    // NEW: Variables for recording state
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    let audioStream;

    function toggleAdvanced() {
      const adv = document.getElementById('advancedOptions');
      adv.classList.toggle('active');
    }

    function showToast(message, type = 'info') {
      const el = document.getElementById('toast');
      el.className = 'toast'; // Reset classes
      if (type === 'success') el.classList.add('success');
      if (type === 'error') el.classList.add('error');
      el.textContent = message;
      
      el.classList.add('show');
      
      setTimeout(() => { 
        el.classList.remove('show');
      }, 3000);
    }

    function withLoading(buttonEl, fn) {
      return async (...args) => {
        const original = buttonEl.innerHTML;
        buttonEl.setAttribute('disabled', 'true');
        buttonEl.innerHTML = '<span class="spinner"></span><span>Working...</span>';
        try { 
          await fn(...args); 
        } catch (error) {
          console.error('Operation failed:', error);
          showToast(error.message || 'An unknown error occurred.', 'error');
        } finally {
          buttonEl.removeAttribute('disabled');
          buttonEl.innerHTML = original;
        }
      }
    }

    function clearAudio(id) {
      const el = document.getElementById(id);
      el.removeAttribute('src');
      el.load();
    }

    async function loadProfiles() {
      try {
        const res = await fetch('/voice_profiles');
        if (!res.ok) {
          throw new Error(`Failed to load profiles: ${res.statusText}`);
        }
        const data = await res.json();
        ttsProfileSel.innerHTML = '';
        if (data.profiles.length === 0) {
            let opt = document.createElement('option');
            opt.textContent = "No profiles found";
            opt.disabled = true;
            ttsProfileSel.appendChild(opt);
        } else {
            data.profiles.forEach(profile => {
                let opt = document.createElement('option');
                opt.value = profile;
                opt.textContent = profile.charAt(0).toUpperCase() + profile.slice(1);
                ttsProfileSel.appendChild(opt);
            });
        }
        handleProfileChange();
      } catch (error) {
        console.error(error);
        showToast('Could not load voice profiles.', 'error');
      }
    }

    const generateTTS = withLoading(btnTTS, async function() {
      const text = document.getElementById('ttsText').value.trim();
      const profile = ttsProfileSel.value;
      if (!text) {
        showToast('Please enter text.', 'error');
        return;
      }
      if (!profile) {
        showToast('Please select a voice profile.', 'error');
        return;
      }

      const body = {
        text,
        profile_name: profile,
        exaggeration: parseFloat(document.getElementById('exaggeration').value),
        cfg_weight: parseFloat(document.getElementById('cfgWeight').value),
        temperature: parseFloat(document.getElementById('temperature').value),
        seed_num: parseInt(document.getElementById('seedNum').value),
        min_p: parseFloat(document.getElementById('minP').value),
        top_p: parseFloat(document.getElementById('topP').value),
        repetition_penalty: parseFloat(document.getElementById('repPenalty').value)
      };

      const response = await fetch('/voice_clone/text_to_speech', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      if (!response.ok) {
        const errorText = await response.text();
        showToast(`Generation failed: ${errorText}`, 'error');
        return;
      }

      const blob = await response.blob();
      document.getElementById('ttsAudio').src = URL.createObjectURL(blob);
      showToast('Speech generated successfully.', 'success');
    });

    const saveProfile = withLoading(btnSave, async function() {
      const profileName = (document.getElementById('profileName').value || '').trim().toLowerCase();
      const fileInput = document.getElementById('profileFile');
      const file = fileInput.files[0];
      if (!file || !profileName) {
        showToast('Please provide a profile name and an audio file.', 'error');
        return;
      }

      const formData = new FormData();
      formData.append('file', file);
      formData.append('profile_name', profileName);

      const response = await fetch('/voice_clone/voice_save', { method: 'POST', body: formData });
      if (response.ok) {
        const data = await response.json();
        showToast(`Saved profile "${data.profile_name}".`, 'success');
        await loadProfiles();
        ttsProfileSel.value = data.profile_name;
        handleProfileChange();
        resetSaveForm();
      } else {
        const errorText = await response.text();
        showToast(`Save failed: ${errorText}`, 'error');
      }
    });

    async function deleteProfile() {
        const profileName = ttsProfileSel.value;
        if (!profileName || PROTECTED_PROFILES.includes(profileName)) {
            showToast('This profile cannot be deleted.', 'error');
            return;
        }

        const confirmation = confirm(`Are you sure you want to delete the profile "${profileName}"?\nThis action cannot be undone.`);
        if (!confirmation) {
            return;
        }

        // --- Release audio file before deleting ---
        const audioEl = document.getElementById('profileAudio');
        if (audioEl) {
            audioEl.pause();
            audioEl.removeAttribute('src');
            audioEl.load();
        }

        btnDeleteProfile.disabled = true;
        try {
            const response = await fetch(`/voice_profiles/${profileName}`, { method: 'DELETE' });
            if (response.ok) {
                showToast(`Profile "${profileName}" deleted.`, 'success');
                await loadProfiles(); // Refresh the list
            } else {
                const errorText = await response.text();
                showToast(`Deletion failed: ${errorText}`, 'error');
            }
        } catch (error) {
            showToast(`An error occurred: ${error.message}`, 'error');
        } finally {
            // The button state will be correctly set by loadProfiles -> handleProfileChange
        }
    }

    function resetSaveForm() {
      document.getElementById('profileName').value = '';
      document.getElementById('profileFile').value = '';
      
      // NEW: Clear and hide the preview audio player
      const audioWrapper = document.getElementById('profileUploadAudioWrapper');
      const audioEl = document.getElementById('profileUploadAudio');
      audioEl.src = '';
      audioWrapper.style.display = 'none';
    }

    function handleProfileChange() {
      const profile = ttsProfileSel.value;
      const audioEl = document.getElementById('profileAudio');
      
      // Update audio player
      if (!profile) {
        audioEl.style.display = 'none';
        audioEl.src = '';
      } else {
        audioEl.src = `/voice_profiles/${profile}/audio`;
        audioEl.style.display = 'block';
      }

      // Update delete button state
      if (!profile || PROTECTED_PROFILES.includes(profile)) {
        btnDeleteProfile.disabled = true;
        btnDeleteProfile.title = "This is a protected profile and cannot be deleted.";
      } else {
        btnDeleteProfile.disabled = false;
        btnDeleteProfile.title = `Delete profile "${profile}"`;
      }
    }

    // NEW: Function to encode raw audio data into a WAV file blob
    function encodeWAV(samples, sampleRate) {
        const buffer = new ArrayBuffer(44 + samples.length * 2);
        const view = new DataView(buffer);

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        const channels = 1;
        const bitDepth = 16;
        
        writeString(view, 0, 'RIFF');
        view.setUint32(4, 36 + samples.length * 2, true);
        writeString(view, 8, 'WAVE');
        writeString(view, 12, 'fmt ');
        view.setUint32(16, 16, true);
        view.setUint16(20, 1, true);
        view.setUint16(22, channels, true);
        view.setUint32(24, sampleRate, true);
        view.setUint32(28, sampleRate * channels * (bitDepth / 8), true);
        view.setUint16(32, channels * (bitDepth / 8), true);
        view.setUint16(34, bitDepth, true);
        writeString(view, 36, 'data');
        view.setUint32(40, samples.length * 2, true);

        for (let i = 0; i < samples.length; i++) {
            const s = Math.max(-1, Math.min(1, samples[i]));
            view.setInt16(44 + i * 2, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
        }

        return new Blob([view], { type: 'audio/wav' });
    }

    // NEW: Function to handle starting and stopping the recording
    async function handleRecording() {
        const btnRecord = document.getElementById('btnRecord');
        const btnRecordText = btnRecord.querySelector('span');

        if (isRecording) {
            // Stop recording
            mediaRecorder.stop();
            audioStream.getTracks().forEach(track => track.stop());
            isRecording = false;
            btnRecord.classList.remove('is-recording');
            btnRecordText.textContent = 'Record';
            showToast('Recording stopped.', 'info');
        } else {
            // Start recording
            try {
                audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                isRecording = true;
                btnRecord.classList.add('is-recording');
                btnRecordText.textContent = 'Stop';
                audioChunks = [];

                mediaRecorder = new MediaRecorder(audioStream);
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
                    const arrayBuffer = await audioBlob.arrayBuffer();
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                    
                    const pcmData = audioBuffer.getChannelData(0);
                    const wavBlob = encodeWAV(pcmData, audioBuffer.sampleRate);
                    const wavFile = new File([wavBlob], "recording.wav", { type: "audio/wav" });

                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(wavFile);
                    document.getElementById('profileFile').files = dataTransfer.files;

                    // NEW: Show audio preview
                    const audioWrapper = document.getElementById('profileUploadAudioWrapper');
                    const audioEl = document.getElementById('profileUploadAudio');
                    audioEl.src = URL.createObjectURL(wavBlob); // Use the wavBlob for preview
                    audioWrapper.style.display = 'block';
                    
                    showToast('Recording converted to WAV and ready for upload.', 'success');
                };

                mediaRecorder.start();
                showToast('Recording started...', 'info');
            } catch (err) {
                console.error("Error accessing microphone:", err);
                showToast('Microphone access was denied.', 'error');
                isRecording = false;
                btnRecord.classList.remove('is-recording');
                btnRecordText.textContent = 'Record';
            }
        }
    }

    // Event Listeners
    ttsProfileSel.addEventListener('change', handleProfileChange);
    btnDeleteProfile.addEventListener('click', deleteProfile);
    window.addEventListener('DOMContentLoaded', () => {
      loadProfiles();
      
      // Initialize slider value displays
      const sliders = document.querySelectorAll('input[type="range"]');
      sliders.forEach(slider => {
        if (slider.nextElementSibling && slider.nextElementSibling.classList.contains('slider-value')) {
          slider.nextElementSibling.textContent = slider.value;
        }
      });

      // NEW: Add event listener for the record button
      document.getElementById('btnRecord').addEventListener('click', handleRecording);

      // NEW: Add event listener for the file input to preview audio
      document.getElementById('profileFile').addEventListener('change', function(event) {
          const file = event.target.files[0];
          const audioWrapper = document.getElementById('profileUploadAudioWrapper');
          const audioEl = document.getElementById('profileUploadAudio');

          if (file) {
              const url = URL.createObjectURL(file);
              audioEl.src = url;
              audioWrapper.style.display = 'block';
          } else {
              audioEl.src = '';
              audioWrapper.style.display = 'none';
          }
      });
    });
  </script>
</body>
</html>